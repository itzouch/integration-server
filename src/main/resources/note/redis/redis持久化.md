

# redis持久化机制？
1. RDB：类似于MySQL中的binlog，二进制形式压缩存储，保存了了某一时间点的数据集。很适合做备份，但是操作太频繁有性能影响。 但是当设置备份时间后，
这段时间内如果宕机会造成这个时间段的数据丢失。
配置文件中修改：
save n m      //n秒内至少有m个改动
save 60 1000  //60s内至少有1000个key被改动

也可以手动执行save命令或者bgsave命令。
bgsave采用的是操作系统的写时复制机制COW (copy on write) redis默认配置的就是这个。

2. AOF：命令追加来保存，保存到的是linux中的pagecache，然后执行命令去刷盘。刷盘的策略有3种
 - 每个命令都刷
 - 每一秒刷一次，由后台线程负责
 - 不主动刷盘，由操作系统控制
最多会丢1s的数据，AOF文件比RDB文件大

3. RDB+AOF
描述：混合持久化并不是一种全新的持久化方式，而是对已有方式的优化。混合持久化只发生于 AOF 重写过程。使用了混合持久化，重写后的新 AOF 文件前半段是 RDB 格式的全量数据，后半段是 AOF 格式的增量数据。
整体格式为：[RDB file][AOF tail]
开启：混合持久化的配置参数为 aof-use-rdb-preamble，配置为 yes 时开启混合持久化，在 redis 4 刚引入时，默认是关闭混合持久化的，但是在 redis 5 中默认已经打开了。
关闭：使用 aof-use-rdb-preamble no 配置即可关闭混合持久化。
混合持久化本质是通过 AOF 后台重写（bgrewriteaof 命令）完成的，不同的是当开启混合持久化时，fork 出的子进程先将当前全量数据以 RDB 方式写入新的 AOF 文件，然后再将 AOF 重写缓冲区（aof_rewrite_buf_blocks）的增量命令以 AOF 方式写入到文件，写入完成后通知主进程将新的含有 RDB 格式和 AOF 格式的 AOF 文件替换旧的的 AOF 文件。
优点：结合 RDB 和 AOF 的优点, 更快的重写和恢复。
缺点：AOF 文件里面的 RDB 部分不再是 AOF 格式，可读性差。
